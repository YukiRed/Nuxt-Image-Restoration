name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout the repository
    - uses: actions/checkout@v4

    # Step 2: Log in to DockerHub (replace this step with GHCR login if needed)
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # Step 3: Set up Docker Buildx for multi-platform builds
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    # Step 4: Build the Docker image and tag it with a timestamp and the commit SHA
    - name: Build the Docker image
      run: |
        IMAGE_NAME=${{ secrets.DOCKER_USERNAME }}/img-restoration
        TIMESTAMP=$(date +%s)
        COMMIT_SHA=${{ github.sha }}
        docker build . --file Dockerfile --tag $IMAGE_NAME:$TIMESTAMP --tag $IMAGE_NAME:$COMMIT_SHA --tag $IMAGE_NAME:latest

    # Step 5: Push the Docker image to DockerHub (replace with GHCR if needed)
    - name: Push Docker image
      run: |
        IMAGE_NAME=${{ secrets.DOCKER_USERNAME }}/img-restoration
        TIMESTAMP=$(date +%s)
        COMMIT_SHA=${{ github.sha }}
        docker push $IMAGE_NAME:$TIMESTAMP
        docker push $IMAGE_NAME:$COMMIT_SHA
        docker push $IMAGE_NAME:latest
